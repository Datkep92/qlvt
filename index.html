<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu·∫£n L√Ω Thi·∫øt B·ªã Y T·∫ø - BV Ninh Thu·∫≠n</title>
    
    <!-- Select2 CSS -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="enhanced-devices.css">
    <link rel="preload" href="https://cdn.jsdelivr.net/npm/chart.js" as="script">
    
    
    <style>
        .loading-app {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            font-size: 18px;
            color: #666;
        }
        
        .loading-spinner {
            font-size: 48px;
            margin-bottom: 20px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        /* CSS b·ªï sung cho Select2 v√† t√≠nh nƒÉng creatable */
        .select2-container .select2-selection--single {
            height: 38px !important;
            border-radius: 4px !important;
            border: 1px solid #ced4da !important;
        }
        
        .select2-container--default .select2-selection--single .select2-selection__rendered {
            line-height: 36px !important;
        }
        
        .select2-container--default .select2-selection--single .select2-selection__arrow {
            height: 36px !important;
        }
        
        /* Style cho option t·∫°o m·ªõi */
        .select2-results__option--create {
            color: #007bff !important;
            font-style: italic !important;
            background-color: #f8f9fa !important;
        }
        
        .select2-results__option--create:hover {
            background-color: #e9ecef !important;
        }
        
        /* Dropdown width cho form */
        .modal .select2-container {
            width: 100% !important;
        }
    </style>
</head>
<body>
    <div id="app">
        <!-- App s·∫Ω ƒë∆∞·ª£c render b·ªüi hienthi.js -->
        <div class="loading-app">
            <div class="loading-spinner">üîÑ</div>
            <p>ƒêang t·∫£i ·ª©ng d·ª•ng...</p>
        </div>
    </div>
<script src="https://unpkg.com/qrcode-generator@1.4.4/qrcode.js"></script>

    <!-- jQuery (y√™u c·∫ßu cho Select2) -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    
    <!-- Select2 JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js"></script>
    
    <!-- Charts & Excel Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script src="./libs/qrcode.min.js"></script>


    <!-- Database -->
    <script src="database.js"></script>
    
    <!-- Core System -->
    <script src="app.js"></script>
    
    <!-- Modules -->
    <script src="demo-data.js"></script>
    <script src="hienthi.js"></script>
    <script src="history.js"></script>
    <script src="quanly.js"></script>
    <script src="loc.js"></script>
    <script src="phanloai.js"></script>
    <script src="thongke.js"></script>
    <script src="baotri.js"></script>
    <script src="xuatdulieu.js"></script>
    <script src="notification.js"></script>
    <script src="grouping.js"></script>
    <script src="import.js"></script>
    

    <!-- Script t√πy ch·ªânh cho creatable select -->
    <script>
        // H√†m kh·ªüi t·∫°o Select2 cho c√°c dropdown
        function initializeSelect2() {
            // Kh·ªüi t·∫°o cho dropdown trong bulk panel
            setTimeout(() => {
                // Bulk panel dropdowns
                if ($('#bulk-category').length) {
                    $('#bulk-category').select2({
                        placeholder: "üìã Ch·ªçn ph√¢n lo·∫°i...",
                        allowClear: true,
                        tags: true,
                        createTag: function (params) {
                            const term = $.trim(params.term);
                            if (term === '') return null;
                            
                            return {
                                id: term.toLowerCase().replace(/\s+/g, '-'),
                                text: term.toUpperCase() + ' (m·ªõi)',
                                newTag: true,
                                group: 'created'
                            };
                        }
                    }).on('select2:select', handleNewCategory);
                }
                
                if ($('#bulk-department').length) {
                    $('#bulk-department').select2({
                        placeholder: "üè• Thay ƒë·ªïi ph√≤ng ban...",
                        allowClear: true,
                        tags: true,
                        createTag: function (params) {
                            const term = $.trim(params.term);
                            if (term === '') return null;
                            
                            return {
                                id: term,
                                text: term + ' (t·∫°o m·ªõi)',
                                newTag: true
                            };
                        }
                    }).on('select2:select', handleNewDepartment);
                }
                
                if ($('#bulk-staff').length) {
                    $('#bulk-staff').select2({
                        placeholder: "üë§ Thay ƒë·ªïi nh√¢n vi√™n...",
                        allowClear: true,
                        tags: true,
                        createTag: function (params) {
                            const term = $.trim(params.term);
                            if (term === '') return null;
                            
                            return {
                                id: term,
                                text: term + ' (th√™m m·ªõi)',
                                newTag: true
                            };
                        }
                    }).on('select2:select', handleNewStaff);
                }
                
                if ($('#bulk-unit').length) {
                    $('#bulk-unit').select2({
                        placeholder: "üì¶ Thay ƒë·ªïi ƒë∆°n v·ªã...",
                        allowClear: true,
                        tags: true,
                        createTag: function (params) {
                            const term = $.trim(params.term);
                            if (term === '') return null;
                            
                            return {
                                id: term,
                                text: term + ' (th√™m m·ªõi)',
                                newTag: true
                            };
                        }
                    }).on('select2:select', handleNewUnit);
                }
                
                // Kh·ªüi t·∫°o cho dropdown trong form ch·ªânh s·ª≠a thi·∫øt b·ªã
                if ($('#edit-phong-ban').length) {
                    $('#edit-phong-ban').select2({
                        placeholder: "Ch·ªçn ph√≤ng ban",
                        allowClear: true,
                        tags: true,
                        createTag: function (params) {
                            const term = $.trim(params.term);
                            if (term === '') return null;
                            
                            return {
                                id: term,
                                text: term + ' (t·∫°o m·ªõi)',
                                newTag: true
                            };
                        }
                    }).on('select2:select', handleNewDepartment);
                }
                
                if ($('#edit-nhan-vien').length) {
                    $('#edit-nhan-vien').select2({
                        placeholder: "Ch·ªçn nh√¢n vi√™n",
                        allowClear: true,
                        tags: true,
                        createTag: function (params) {
                            const term = $.trim(params.term);
                            if (term === '') return null;
                            
                            return {
                                id: term,
                                text: term + ' (th√™m m·ªõi)',
                                newTag: true
                            };
                        }
                    }).on('select2:select', handleNewStaff);
                }
            }, 500);
        }
        
        // X·ª≠ l√Ω t·∫°o ph√¢n lo·∫°i m·ªõi
        async function handleNewCategory(e) {
            const data = e.params.data;
            if (data.newTag) {
                const categoryName = data.text.replace(' (m·ªõi)', '');
                
                // Hi·ªÉn th·ªã th√¥ng b√°o
                AppEvents.emit('notification:show', {
                    message: `ƒê√£ th√™m ph√¢n lo·∫°i: ${categoryName}`,
                    type: 'success'
                });
                
                // Ph√¢n lo·∫°i s·∫£n ph·∫©m th∆∞·ªùng kh√¥ng c·∫ßn l∆∞u v√†o database
                // Ch·ªâ c·∫ßn th√™m v√†o dropdown l√† ƒë·ªß
            }
        }
        
        // X·ª≠ l√Ω t·∫°o ph√≤ng ban m·ªõi
        async function handleNewDepartment(e) {
            const data = e.params.data;
            if (data.newTag && window.phanLoaiXuLyManager) {
                const deptName = data.text.replace(' (t·∫°o m·ªõi)', '');
                
                try {
                    await medicalDB.addDepartment({ ten_phong: deptName });
                    
                    // Refresh filter dropdown
                    if (window.locManager && window.locManager.loadDepartments) {
                        window.locManager.loadDepartments();
                    }
                    
                    AppEvents.emit('notification:show', {
                        message: `ƒê√£ th√™m ph√≤ng ban: ${deptName}`,
                        type: 'success'
                    });
                } catch (error) {
                    AppEvents.emit('notification:show', {
                        message: `L·ªói khi th√™m ph√≤ng ban: ${error.message}`,
                        type: 'error'
                    });
                    
                    // Reset select
                    $(e.target).val(null).trigger('change');
                }
            }
        }
        
        // X·ª≠ l√Ω t·∫°o nh√¢n vi√™n m·ªõi
        async function handleNewStaff(e) {
            const data = e.params.data;
            if (data.newTag && window.phanLoaiXuLyManager) {
                const staffName = data.text.replace(' (th√™m m·ªõi)', '');
                const position = prompt(`Nh·∫≠p ch·ª©c v·ª• cho "${staffName}" (kh√¥ng b·∫Øt bu·ªôc):`, '');
                
                try {
                    await medicalDB.addStaff({ 
                        ten_nhan_vien: staffName,
                        ten: staffName,
                        chuc_vu: position || ''
                    });
                    
                    // Refresh filter dropdown
                    if (window.locManager && window.locManager.loadStaff) {
                        window.locManager.loadStaff();
                    }
                    
                    AppEvents.emit('notification:show', {
                        message: `ƒê√£ th√™m nh√¢n vi√™n: ${staffName}`,
                        type: 'success'
                    });
                } catch (error) {
                    AppEvents.emit('notification:show', {
                        message: `L·ªói khi th√™m nh√¢n vi√™n: ${error.message}`,
                        type: 'error'
                    });
                    
                    // Reset select
                    $(e.target).val(null).trigger('change');
                }
            }
        }
        
        // X·ª≠ l√Ω t·∫°o ƒë∆°n v·ªã m·ªõi
        async function handleNewUnit(e) {
            const data = e.params.data;
            if (data.newTag && window.phanLoaiXuLyManager) {
                const unitName = data.text.replace(' (th√™m m·ªõi)', '');
                
                try {
                    await medicalDB.addUnit({ ten_don_vi: unitName });
                    
                    // Refresh filter dropdown
                    if (window.locManager && window.locManager.loadUnits) {
                        window.locManager.loadUnits();
                    }
                    
                    AppEvents.emit('notification:show', {
                        message: `ƒê√£ th√™m ƒë∆°n v·ªã: ${unitName}`,
                        type: 'success'
                    });
                } catch (error) {
                    AppEvents.emit('notification:show', {
                        message: `L·ªói khi th√™m ƒë∆°n v·ªã: ${error.message}`,
                        type: 'error'
                    });
                    
                    // Reset select
                    $(e.target).val(null).trigger('change');
                }
            }
        }
        
        // G·ªçi khi app ready
        document.addEventListener('DOMContentLoaded', function() {
            // L·∫Øng nghe s·ª± ki·ªán app ready
            AppEvents.on('app:ready', () => {
                setTimeout(initializeSelect2, 1000);
            });
            
            // C≈©ng g·ªçi khi c√≥ modal m·ªõi ƒë∆∞·ª£c m·ªü
            setInterval(() => {
                if ($('.modal').is(':visible')) {
                    $('.modal select:not(.select2-hidden-accessible)').each(function() {
                        if ($(this).attr('id') && $(this).attr('id').includes('edit-')) {
                            $(this).select2({
                                dropdownParent: $(this).closest('.modal'),
                                tags: true,
                                createTag: function (params) {
                                    const term = $.trim(params.term);
                                    if (term === '') return null;
                                    
                                    const suffix = $(this).attr('id').includes('phong-ban') ? 
                                        ' (t·∫°o m·ªõi)' : ' (th√™m m·ªõi)';
                                    
                                    return {
                                        id: term,
                                        text: term + suffix,
                                        newTag: true
                                    };
                                }
                            });
                        }
                    });
                }
            }, 1000);
        });
        
    </script>
</body>
</html>